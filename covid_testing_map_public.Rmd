---
title: "COVID-19 Testing Site Planning"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
---

```{r setup, include=FALSE}
library(flexdashboard)
```

Column {data-width=250}
-----------------------------------------------------------------------

<font size="3.5">

This map displays census tract-level data in Hamilton County for informing decisions on COVID testing locations.

Using the menu on the left-hand side of the map, you can toggle variables on/off.

Clicking on a tract displays all variables for that tract.

</font>

<font size="3">

Variables Include: 

  * Neighborhood Testing Site Coverage (fraction of neighborhood within 10-min walk of existing test site)

  * American Community Survey Sociodemographic Variables from [The Public Health Disparities Geocoding Project](https://www.hsph.harvard.edu/thegeocodingproject/covid-19-resources/)
      + Percent People of Color (not White Non-Hispanic / Total)
      + Racial/Economic ICE (Index of Concentration at the Extremes for white non-Hispanic high income vs. people of color low income)
      + Total Population 
      + % Crowding (>1 person per room)
      
  * Other American Community Survey Sociodeomgraphic Variables
      + Population Over Age 65
      + Population Density (people per km)
      + Fraction Assisted Income
      + Fraction High School Education
      + Median Income
      + Fraction No Health Insurance
      + Fraction Poverty
      + Fraction Vacant Housing
      + [Deprivation Index](https://geomarker.io/dep_inde)
  
  * Facilities at risk for outbreak
      + Long Term Care Facilities (from CHD)
      + Nursing Homes (from Cincy Tech)
      + Prisons and Jails (from Cincy Tech)
      + Shelters
      + CMHA Housing
  
  * Existing Testing Locations
      + CHD Health Centers
  
  * Potential Testing Locations
      + Cincinnati Public Schools
      + Rec Centers
  

</font>

<br>

<br>

<br>

<font size="2">

Map created by CCHMC GRAPPH.

For questions, contact erika.rasnick@cchmc.org

</font>

Column {data-width=750}
-----------------------------------------------------------------------

```{r data}
library(tidyverse)
library(leaflet)
library(sf)
library(tmap)

d_neigh <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/covid_neighborhood_data.rds') %>% 
  st_transform(3735) %>% 
  mutate_at(vars(positive_per_tests, percColor, crowding, 
                 fraction_assisted_income, fraction_high_school_edu, fraction_no_health_ins, 
                 fraction_poverty, fraction_vacant_housing), ~round(.*100)) %>% 
    select(-pop_under_18, -pop_over_50, -pop_over_80, 
         -positive_per_1000pop, -tests_per_1000pop, -positive_per_tests) %>% 
  mutate_if(is.numeric, ~round(., 2))

ltcf <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/ltcf.rds') %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

nursing_homes <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/nursing_homes.rds') %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

prisons_jails <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/prisons_jails.rds') %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

schools_reccenters <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/schools_reccenters.rds') %>% 
  filter(!is.na(lat)) %>% 
  select(-Tier) %>% 
  rename(lon = long) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

schools <- schools_reccenters %>% 
  filter(Group == 'CPS')

reccenters <- schools_reccenters %>% 
  filter(Group == 'Rec_Center')

shelters <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/shelters.rds') %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

cmha <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/cmha.rds') %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

health_centers <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/health_centers.rds') %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>% 
  st_transform(3735)

health_center_isochrones_10min_walk <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/health_center_isochrones_10min_walk.rds')  %>% 
  st_as_sf()
health_center_isochrones_15min_drive <- aws.s3::s3readRDS('s3://geomarker/covid_testing_locations/health_center_isochrones_15min_drive.rds')  %>% 
  st_as_sf()
```

```{r map, fig.width = 13.5, fig.height = 10, fig.align='center'}
tmap_mode('view')

legend_labels <-  c('% People of Color' = 'percColor', 
                     'Racial/Economic ICE' = 'ICEwnhinc', 
                     'Total Population' = 'pop_total', 
                     'Population Over Age 65' = 'pop_over_65', 
                     'Population Density' = 'pop_density', 
                     '% Crowding' = 'crowding', 
                     '% Assisted Income' = 'fraction_assisted_income', 
                     '% High School Education' = 'fraction_high_school_edu', 
                     'Median Income' = 'median_income', 
                     '% No Health Insurance' = 'fraction_no_health_ins', 
                     '% Poverty' = 'fraction_poverty', 
                     '% Vacant Housing' = 'fraction_vacant_housing', 
                    'Deprivation Index' = 'dep_index', 
                    'Fraction Neighborhood Coverage' = 'frac_coverage')

tm <- tm_shape(d_neigh, 
               name = 'Neighborhoods') +
  tm_polygons(col = "grey50", 
              alpha = 0.2) +
  tm_shape(d_neigh, name = names(legend_labels)[14]) +
  tm_polygons(col = names(d_neigh)[16], 
              title = names(legend_labels)[14],
              alpha = 0.5, 
              palette = '-viridis', 
              style = "cont", 
              popup.vars = legend_labels) +
  tm_shape(d_neigh) +
  tm_polygons(col = names(d_neigh)[c(2, 4:8, 11:14)], 
              title = names(legend_labels)[c(1, 3:7, 10:13)],
              alpha = 0.5, 
              palette = 'viridis', 
              style = "quantile", 
              popup.vars = legend_labels) +
  tm_shape(d_neigh, name = names(legend_labels)[2]) +
  tm_polygons(col = names(d_neigh)[3], 
              title = names(legend_labels)[2],
              alpha = 0.5, 
              palette = '-viridis', 
              style = "quantile",
              midpoint = 0,
              popup.vars = legend_labels) +
  tm_shape(d_neigh, name = names(legend_labels)[8:9]) +
  tm_polygons(col = names(d_neigh)[c(9:10)], 
              title = names(legend_labels)[8:9],
              alpha = 0.5, 
              palette = '-viridis', 
              style = "quantile",
              popup.vars = legend_labels) +
  tm_facets(as.layers = TRUE, 
            free.scales.fill = TRUE) + 
  tm_shape(ltcf, name = 'Long Term Care Facilities') +
  tm_dots(size = 0.1, 
          col = "black",
          alpha = 0.5) +
  tm_shape(nursing_homes, name = 'Nursing Homes') +
  tm_dots(size = 0.1, 
          col = "blue",
          alpha = 0.5) +
  tm_shape(prisons_jails, name = 'Prisons and Jails') +
  tm_dots(size = 0.1, 
          col = "red",
          alpha = 0.5) +
  tm_shape(schools, name = 'Public Schools') +
  tm_dots(size = 0.1,
          col = "orange",
          alpha = 0.5) +
  tm_shape(reccenters, name = 'Rec Centers') +
  tm_dots(size = 0.1, 
          col = "purple",
          alpha = 0.5) +
  tm_shape(shelters, name = 'Shelters') +
  tm_dots(size = 0.1, 
          col = "green",
          alpha = 0.5) +
  tm_shape(cmha, name = 'CMHA Housing') +
  tm_dots(size = 0.1, 
          col = "gray",
          alpha = 0.5) +
  tm_shape(health_centers, name = 'Existing Testing Locations') +
  tm_dots(size = 0.1, 
          col = "white",
          alpha = 0.5) +
  tm_shape(health_center_isochrones_10min_walk, 
           name = '10-min walk buffer to test site') +
  tm_polygons(col = 'white', alpha = 0.5) +
  tm_shape(health_center_isochrones_15min_drive, 
           name = '15-min drive buffer to test site') +
  tm_polygons(col = 'gray', alpha = 0.5) +
  tm_scale_bar()


tm %>%
  tmap_leaflet() %>% 
  leaflet::hideGroup(names(legend_labels)[1:13]) %>% 
      leaflet::hideGroup('Long Term Care Facilities') %>% 
    leaflet::hideGroup('Nursing Homes') %>% 
      leaflet::hideGroup('Prisons and Jails') %>% 
        leaflet::hideGroup('Public Schools') %>% 
        leaflet::hideGroup('Rec Centers') %>% 
          leaflet::hideGroup('Shelters') %>% 
            leaflet::hideGroup('CMHA Housing') %>% 
              leaflet::hideGroup('15-min drive buffer to test site') %>% 
  addLegend("bottomright", values = dates,
            colors = "black", 
            labels = "Long Term Care Facilities",
            title = "",
            opacity = 1) %>% 
    addLegend("bottomright", values = dates,
            colors = "blue", 
            labels = "Nursing Homes",
            title = "",
            opacity = 1) %>% 
      addLegend("bottomright", values = dates,
            colors = "red", 
            labels = "Prisons and Jails",
            title = "",
            opacity = 1) %>% 
        addLegend("bottomright", values = dates,
            colors = "orange", 
            labels = "Public Schools",
            title = "",
            opacity = 1) %>% 
        addLegend("bottomright", values = dates,
            colors = "purple", 
            labels = "Rec Centers",
            title = "",
            opacity = 1) %>% 
          addLegend("bottomright", values = dates,
            colors = "green", 
            labels = "Shelters",
            title = "",
            opacity = 1) %>% 
  addLegend("bottomright", values = dates,
            colors = "gray", 
            labels = "CMHA Housing",
            title = "",
            opacity = 1) %>% 
    addLegend("bottomright", values = dates,
            colors = "white", 
            labels = "Existing Testing Locations",
            title = "",
            opacity = 1)

```


